<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Supreme Strategic Campaign Simulator (Iraq)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles: Dynamic Propaganda-Themed Aesthetics */
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 70%, #0f172a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #f8fafc;
            padding-bottom: 70px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* Prevent zoom on double-tap */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Propaganda Button Style - Dynamic and inviting */
        #tapButton {
            width: 220px;
            height: 220px;
            background: radial-gradient(circle at center, #3b82f6 0%, #1e40af 70%, #1e3a8a 100%);
            border: 6px solid #fef3c7;
            color: white;
            font-size: 2.25rem;
            font-weight: 900;
            cursor: pointer;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.9);
            box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            position: relative;
            z-index: 10;
            animation: pulse-shadow 2s infinite alternate;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        @keyframes pulse-shadow {
            0% { box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2); }
            100% { box-shadow: 0 20px 50px rgba(37, 99, 235, 0.9), 0 0 0 18px rgba(254, 243, 199, 0.4); }
        }

        #tapButton:active {
            transform: scale(0.95) rotateZ(-1deg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
            animation: none;
        }

        /* Floating text feedback */
        .tap-feedback {
            position: absolute;
            font-size: 1.8rem;
            font-weight: 900;
            color: #fcd34d;
            text-shadow: 0 2px 8px #000;
            pointer-events: none;
            animation: floatup 0.9s ease-out forwards;
            white-space: nowrap;
            z-index: 100;
        }
        @keyframes floatup {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-70px) scale(0.8); opacity: 0; }
        }

        /* Enhanced tap effects */
        .tap-ripple {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.4) 0%, transparent 70%);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
            z-index: 5;
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }

        /* General Card styles */
        .card-item {
            background: #1e293b;
            border: 1px solid #475569;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            transition: transform 0.2s;
        }
        .card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
        }
        
        /* Active card glow effect */
        .card-active {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
            border-color: #22c55e;
        }
        
        /* Nav Bar */
        .nav-bar {
            box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.8);
            background-color: #0f172a;
        }
        .nav-item {
            color: #94a3b8;
            cursor: pointer;
        }
        .nav-item.active {
            color: #3b82f6;
            background-color: #1e293b;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
        }
        
        /* Auto-tap progress bar */
        .auto-tap-progress {
            width: 100%;
            height: 6px;
            background: #374151;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        .auto-tap-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Critical tap animation */
        @keyframes criticalTap {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .critical-tap {
            animation: criticalTap 0.4s ease;
            color: #fbbf24 !important;
        }

        /* Leaderboard styles */
        .leaderboard-item {
            transition: all 0.3s ease;
        }
        .leaderboard-item:hover {
            transform: translateX(5px);
        }
        .current-user {
            background: linear-gradient(135deg, #1e40af30, #3b82f630) !important;
            border-left: 4px solid #3b82f6;
        }

        /* Media Gallery Styles */
        .media-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .media-card:hover {
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        .candidate-photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid;
        }
        .party-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        .promo-video-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 sm:p-6 pb-20 max-w-lg mx-auto">

    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900/80 z-50 justify-center items-center hidden">
        <p class="text-white text-xl animate-pulse">Loading Campaign Data...</p>
    </div>

    <div id="messageBox" style="display: none;"></div>

    <!-- Video Modal -->
    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden justify-center items-center">
        <div class="bg-slate-800 rounded-xl p-4 m-4 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white" id="videoTitle">Campaign Video</h3>
                <button onclick="closeVideoModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="videoContainer" class="w-full h-64 bg-black rounded-lg flex items-center justify-center">
                <p class="text-gray-400">Video player will load here</p>
            </div>
            <div class="mt-4 flex justify-between">
                <span class="text-green-400 font-bold" id="videoReward">+5,000 coins reward</span>
                <button onclick="claimVideoReward()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded">
                    Claim Reward
                </button>
            </div>
        </div>
    </div>

    <header class="w-full mb-6 p-4 bg-slate-800/80 rounded-xl shadow-2xl border border-slate-700/50">
        <h1 class="text-xl font-extrabold text-center mb-4 text-yellow-500">Supreme Strategic Campaign Simulator</h1>
        <div class="flex justify-around text-center">
            <div>
                <p class="text-3xl font-extrabold text-yellow-400" id="coinCounter">0</p>
                <p class="text-sm text-gray-400">Campaign Funds 💰</p>
            </div>
            <div>
                <p class="text-3xl font-extrabold text-purple-400" id="tokenCounter">0</p>
                <p class="text-sm text-gray-400">Influence Tokens 💎</p>
            </div>
            <div>
                <p class="text-3xl font-extrabold text-green-400" id="tciCounter">0</p>
                <p class="text-sm text-gray-400">Total Influence (TCI) 📈</p>
            </div>
        </div>
    </header>

    <main class="w-full flex-grow">
        <div id="tap" class="tab-content flex flex-col items-center">
            <!-- Auto-tap indicator -->
            <div id="autoTapIndicator" class="w-full max-w-sm mb-4 p-3 bg-slate-800/80 rounded-xl border border-green-500/50 hidden">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-green-400 font-bold">🤖 Auto-Tap Active</span>
                    <span id="autoTapTimer" class="text-gray-300">30s</span>
                </div>
                <div class="auto-tap-progress">
                    <div id="autoTapProgress" class="auto-tap-fill" style="width: 100%"></div>
                </div>
            </div>
            
            <div class="relative mb-8 mt-4">
                <button id="tapButton" class="rounded-full flex flex-col justify-center items-center">
                    Tap to<br/>Fund<br/><span class="text-3xl">+1</span>
                </button>
            </div>
            
            <!-- Active Cards Bonus Display -->
            <div id="activeCardsBonus" class="w-full max-w-sm mb-4 p-3 bg-slate-800/80 rounded-xl border border-blue-500/50 hidden">
                <h4 class="text-blue-400 font-bold text-sm mb-2">🎴 Active Cards Bonus</h4>
                <div id="activeCardsList" class="text-xs text-gray-300 space-y-1"></div>
            </div>
            
            <div class="w-full p-4 bg-slate-800/80 rounded-xl shadow-xl border border-slate-700/50">
                <h3 class="font-bold text-lg text-blue-300 mb-2">Daily Campaign Goal (100 Taps)</h3>
                <p class="text-sm text-gray-400 mb-2 flex justify-between">
                    <span>Progress: <span id="dailyTapsCount">0/100</span></span>
                    <span class="text-yellow-400">+5000 💰 & +1 💎 Reward</span>
                </p>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="dailyProgress" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="cards" class="tab-content hidden">
            <div id="cardsContainer" class="w-full"></div>
        </div>

        <div id="party" class="tab-content hidden">
            <div id="partyContainer" class="w-full"></div>
        </div>
        
        <div id="media" class="tab-content hidden">
            <div id="mediaContainer" class="w-full"></div>
        </div>
        
        <div id="store" class="tab-content hidden">
            <div id="storeContainer" class="w-full"></div>
        </div>

        <div id="leaderboard" class="tab-content hidden">
            <div id="leaderboardContainer" class="w-full"></div>
        </div>
    </main>

    <nav class="nav-bar fixed bottom-0 left-0 right-0 max-w-lg mx-auto w-full flex justify-around p-3 border-t border-gray-700/50 rounded-t-xl z-40">
        <a class="nav-item flex flex-col items-center p-2 rounded-lg transition" data-tab="tap">
            <span class="text-xl">👆</span>
            <span class="text-xs mt-1">Tap</span>
        </a>
        <a class="nav-item flex flex-col items-center p-2 rounded-lg transition relative" data-tab="cards">
            <span class="text-xl">🎴</span>
            <span class="text-xs mt-1">Cards</span>
            <span id="cardNotif" class="hidden absolute top-0 right-0 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
        </a>
        <a class="nav-item flex flex-col items-center p-2 rounded-lg transition" data-tab="party">
            <span class="text-xl">🏛️</span>
            <span class="text-xs mt-1">Party</span>
        </a>
        <a class="nav-item flex flex-col items-center p-2 rounded-lg transition" data-tab="media">
            <span class="text-xl">📷</span>
            <span class="text-xs mt-1">Media</span>
        </a>
        <a class="nav-item flex flex-col items-center p-2 rounded-lg transition" data-tab="store">
            <span class="text-xl">💎</span>
            <span class="text-xs mt-1">Store</span>
        </a>
        <a class="nav-item flex flex-col items-center p-2 rounded-lg transition" data-tab="leaderboard">
            <span class="text-xl">🏆</span>
            <span class="text-xs mt-1">Rank</span>
        </a>
    </nav>

    <script>
        // ENHANCED CAMPAIGN SIMULATOR WITH MEDIA INTEGRATION
        // Base Game Constants
        const TAPS_PER_CARD_DROP_BASE = 10;
        const DAILY_GOAL = 100;
        const DAILY_REWARD_COINS = 5000;
        const DAILY_REWARD_TOKENS = 1;
        const TCI_SCALING = {
            COINS: 10000,
            CARD_LEVEL: 10,
            PARTY_LEVEL: 50
        };

        // Netlify Leaderboard Configuration
        const LEADERBOARD_ENABLED = true;
        const LEADERBOARD_URL = '/.netlify/functions/leaderboard';

        // Enhanced Iraqi Political Party Data with Media
        const INITIAL_PARTY_DATA = {
            p1: { 
                name: "تيار سائرون (Sairoon Current)", 
                level: 1, 
                xp: 0, 
                multiplier: 1.0, 
                logo: '🇮🇶', 
                color: 'bg-red-700',
                logoImage: '/assets/parties/logos/p1-sairoon.png',
                bannerImage: '/assets/parties/banners/p1-sairoon-banner.jpg',
                socialLinks: {
                    website: "https://sairoon-party.iq",
                    twitter: "https://twitter.com/sairoon_party",
                    youtube: "https://youtube.com/c/SairoonParty"
                },
                description: "A cross-sectarian alliance led by Muqtada al-Sadr"
            },
            p2: { 
                name: "تحالف الفتح (Fatah Alliance)", 
                level: 1, 
                xp: 0, 
                multiplier: 1.0, 
                logo: '🛡️', 
                color: 'bg-green-700',
                logoImage: '/assets/parties/logos/p2-fatah.png',
                bannerImage: '/assets/parties/banners/p2-fatah-banner.jpg',
                socialLinks: {
                    website: "https://fatah-alliance.iq",
                    twitter: "https://twitter.com/fatah_alliance",
                    youtube: "https://youtube.com/c/FatahAlliance"
                },
                description: "Coalition of Iran-backed parties"
            },
            p3: { 
                name: "الحزب الديمقراطي الكردستاني (KDP)", 
                level: 1, 
                xp: 0, 
                multiplier: 1.0, 
                logo: '⛰️', 
                color: 'bg-yellow-700',
                logoImage: '/assets/parties/logos/p3-kdp.png',
                bannerImage: '/assets/parties/banners/p3-kdp-banner.jpg',
                socialLinks: {
                    website: "https://kdp.org",
                    twitter: "https://twitter.com/kdp_news",
                    youtube: "https://youtube.com/c/KDPOfficial"
                },
                description: "Kurdistan Democratic Party"
            },
            p4: { 
                name: "تحالف تقدم (Taqaddum Coalition)", 
                level: 1, 
                xp: 0, 
                multiplier: 1.0, 
                logo: '🏗️', 
                color: 'bg-blue-700',
                logoImage: '/assets/parties/logos/p4-taqaddum.png',
                bannerImage: '/assets/parties/banners/p4-taqaddum-banner.jpg',
                socialLinks: {
                    website: "https://taqaddum.iq",
                    twitter: "https://twitter.com/taqaddum_coal",
                    youtube: "https://youtube.com/c/TaqaddumCoalition"
                },
                description: "Progress Coalition led by Mohammed al-Halbousi"
            },
            p5: { 
                name: "مستقلون/تشرين (Tishreen/Independents)", 
                level: 1, 
                xp: 0, 
                multiplier: 1.0, 
                logo: '✊', 
                color: 'bg-purple-700',
                logoImage: '/assets/parties/logos/p5-tishreen.png',
                bannerImage: '/assets/parties/banners/p5-tishreen-banner.jpg',
                socialLinks: {
                    website: "https://tishreen-movement.iq",
                    twitter: "https://twitter.com/tishreen_oct",
                    youtube: "https://youtube.com/c/TishreenMovement"
                },
                description: "October Revolution protest movement"
            }
        };

        // Enhanced Candidate pool with Media and Social Features
        const CANDIDATE_POOL = [
            { 
                id: 1, 
                name: "مصطفى العبادي (Mustafa Al-Abadi)", 
                campaign: "مكافحة الفساد", 
                baseBonus: 1, 
                bid: 1000, 
                maxLevel: 5, 
                party: INITIAL_PARTY_DATA.p1.name, 
                logoColor: "text-red-500", 
                partyId: 'p1', 
                policy: "Financial and administrative reform.", 
                approval: 75, 
                logo: '💰',
                specialAbility: "Critical Tap: 5% chance for 3x coins",
                abilityType: "critical",
                photo: "/assets/candidates/photos/c1-mustafa-alabadi.jpg",
                promoVideo: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                videoReward: 5000,
                socialLinks: {
                    website: "https://al-abadi-campaign.iq",
                    twitter: "https://twitter.com/mustafa_alabadi",
                    facebook: "https://facebook.com/mustafa.alabadi.official"
                },
                bio: "Former minister known for anti-corruption efforts"
            },
            { 
                id: 2, 
                name: "فاطمة الجبوري (Fatima Al-Jubouri)", 
                campaign: "خدمات البنية التحتية", 
                baseBonus: 2, 
                bid: 5000, 
                maxLevel: 10, 
                party: INITIAL_PARTY_DATA.p4.name, 
                logoColor: "text-blue-500", 
                partyId: 'p4', 
                policy: "Improved electricity and water access.", 
                approval: 88, 
                logo: '⚡',
                specialAbility: "Auto-Tap: Generates taps every 5 seconds",
                abilityType: "autoTap",
                photo: "/assets/candidates/photos/c2-fatima-aljubouri.jpg",
                promoVideo: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                videoReward: 7500,
                socialLinks: {
                    website: "https://al-jubouri-campaign.iq",
                    twitter: "https://twitter.com/fatima_aljubouri",
                    facebook: "https://facebook.com/fatima.aljubouri.official"
                },
                bio: "Infrastructure expert and civil engineer"
            },
            { 
                id: 3, 
                name: "آلان أحمد (Alan Ahmed)", 
                campaign: "اقتصاد الإقليم", 
                baseBonus: 3, 
                bid: 15000, 
                maxLevel: 15, 
                party: INITIAL_PARTY_DATA.p3.name, 
                logoColor: "text-yellow-500", 
                partyId: 'p3', 
                policy: "Fair share of federal oil and gas revenues.", 
                approval: 65, 
                logo: '⛽',
                specialAbility: "Tap Storm: 30 seconds of rapid tapping",
                abilityType: "tapStorm",
                photo: "/assets/candidates/photos/c3-alan-ahmed.jpg",
                promoVideo: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                videoReward: 10000,
                socialLinks: {
                    website: "https://alan-ahmed-campaign.iq",
                    twitter: "https://twitter.com/alan_ahmed_kdp",
                    facebook: "https://facebook.com/alan.ahmed.official"
                },
                bio: "Economic advisor specializing in oil revenue distribution"
            },
            { 
                id: 4, 
                name: "حيدر الموسوي (Haider Al-Mousawi)", 
                campaign: "الأمن القومي", 
                baseBonus: 5, 
                bid: 30000, 
                maxLevel: 20, 
                party: INITIAL_PARTY_DATA.p2.name, 
                logoColor: "text-green-500", 
                partyId: 'p2', 
                policy: "Strengthening border defense and security forces.", 
                approval: 92, 
                logo: '⚔️',
                specialAbility: "Double Rewards: 2x daily goal rewards",
                abilityType: "doubleRewards",
                photo: "/assets/candidates/photos/c4-haider-almousawi.jpg",
                promoVideo: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                videoReward: 15000,
                socialLinks: {
                    website: "https://al-mousawi-campaign.iq",
                    twitter: "https://twitter.com/haider_almousawi",
                    facebook: "https://facebook.com/haider.almousawi.official"
                },
                bio: "Security analyst and former military commander"
            },
            { 
                id: 5, 
                name: "نور الصراف (Noor Al-Sarraf)", 
                campaign: "الإصلاح المدني", 
                baseBonus: 10, 
                bid: 60000, 
                maxLevel: 25, 
                party: INITIAL_PARTY_DATA.p5.name, 
                logoColor: "text-purple-500", 
                partyId: 'p5', 
                policy: "Push for judicial and electoral independence.", 
                approval: 55, 
                logo: '📜',
                specialAbility: "Party Boost: +50% to all party multipliers",
                abilityType: "partyBoost",
                photo: "/assets/candidates/photos/c5-noor-alsarraf.jpg",
                promoVideo: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                videoReward: 20000,
                socialLinks: {
                    website: "https://al-sarraf-campaign.iq",
                    twitter: "https://twitter.com/noor_alsarraf",
                    facebook: "https://facebook.com/noor.alsarraf.official"
                },
                bio: "Civil rights activist and legal reform advocate"
            }
        ];

        // Game State
        let gameState = {
            coins: 0,
            influenceTokens: 0,
            tapPower: 1,
            cardBonusSum: 0,
            partyMultiplier: 1.0,
            dailyTaps: 0,
            tapCount: 0,
            totalLifetimeCoins: 0,
            totalCampaignInfluence: 0,
            basePowerMultiplier: 1,
            dropRateMultiplier: 1,
            partyMultiplierBonus: 1.0,
            boostsPurchased: [],
            userCards: [],
            parties: {...INITIAL_PARTY_DATA},
            unclaimedCards: [],
            lastDailyRewardDate: null,
            activeCards: [],
            autoTapActive: false,
            autoTapEndTime: 0,
            tapStormActive: false,
            tapStormEndTime: 0,
            userId: 'user_' + Math.random().toString(36).substr(2, 9),
            displayName: '',
            watchedVideos: {} // Track which videos user has watched
        };

        // DOM elements
        let coinCounter, tokenCounter, tapButton, cardsContainer, loadingIndicator, messageBox;
        let autoTapInterval, tapStormInterval;
        let currentVideoCandidate = null;

        // NETLIFY LEADERBOARD FUNCTIONS (Same as before)
        async function submitToLeaderboard() {
            if (!LEADERBOARD_ENABLED) return { success: true, local: true };
            try {
                if (!gameState.displayName) {
                    gameState.displayName = `Player_${gameState.userId.substr(0, 6)}`;
                }
                const response = await fetch(LEADERBOARD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: gameState.userId,
                        display_name: gameState.displayName,
                        score: gameState.totalLifetimeCoins,
                        tci: gameState.totalCampaignInfluence,
                        tap_power: gameState.tapPower,
                        cards_count: gameState.userCards.length,
                        last_updated: new Date().toISOString()
                    })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Failed to submit to leaderboard:', error);
                saveLocalScore();
                return { success: false, error: error.message, local: true };
            }
        }

        function saveLocalScore() {
            try {
                const localScores = JSON.parse(localStorage.getItem('localLeaderboard') || '{}');
                localScores[gameState.userId] = {
                    display_name: gameState.displayName,
                    score: gameState.totalLifetimeCoins,
                    tci: gameState.totalCampaignInfluence,
                    tap_power: gameState.tapPower,
                    cards_count: gameState.userCards.length,
                    last_updated: new Date().toISOString()
                };
                localStorage.setItem('localLeaderboard', JSON.stringify(localScores));
            } catch (error) {
                console.error('Failed to save local score:', error);
            }
        }

        async function getGlobalLeaderboard(limit = 50) {
            if (!LEADERBOARD_ENABLED) return getLocalLeaderboard(limit);
            try {
                const response = await fetch(`${LEADERBOARD_URL}?limit=${limit}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch global leaderboard:', error);
                return getLocalLeaderboard(limit);
            }
        }

        function getLocalLeaderboard(limit = 50) {
            try {
                const localScores = JSON.parse(localStorage.getItem('localLeaderboard') || '{}');
                const scores = Object.entries(localScores).map(([user_id, data]) => ({ user_id, ...data }));
                scores.sort((a, b) => (b.score || 0) - (a.score || 0));
                return scores.slice(0, limit);
            } catch (error) {
                return [];
            }
        }

        // VIDEO FUNCTIONS
        function watchPromoVideo(candidateId) {
            const candidate = CANDIDATE_POOL.find(c => c.id === candidateId);
            if (!candidate) return;
            
            currentVideoCandidate = candidate;
            const modal = document.getElementById('videoModal');
            const title = document.getElementById('videoTitle');
            const reward = document.getElementById('videoReward');
            const container = document.getElementById('videoContainer');
            
            title.textContent = `${candidate.name} - Campaign Video`;
            reward.textContent = `+${candidate.videoReward.toLocaleString()} coins reward`;
            
            // Check if already watched
            if (gameState.watchedVideos[candidateId]) {
                container.innerHTML = `
                    <div class="text-center text-yellow-400">
                        <i class="fas fa-check-circle text-4xl mb-2"></i>
                        <p>You've already watched this video</p>
                        <p class="text-sm text-gray-400">Reward already claimed</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <iframe width="100%" height="100%" src="${candidate.promoVideo}" 
                            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                    </iframe>
                `;
            }
            
            modal.classList.remove('hidden');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.add('hidden');
            document.getElementById('videoContainer').innerHTML = '';
            currentVideoCandidate = null;
        }

        function claimVideoReward() {
            if (!currentVideoCandidate) return;
            
            if (gameState.watchedVideos[currentVideoCandidate.id]) {
                showMessage("You've already claimed reward for this video!", 'error');
                return;
            }
            
            gameState.watchedVideos[currentVideoCandidate.id] = true;
            gameState.coins += currentVideoCandidate.videoReward;
            gameState.totalLifetimeCoins += currentVideoCandidate.videoReward;
            
            showMessage(`🎉 +${currentVideoCandidate.videoReward.toLocaleString()} coins from campaign video!`, 'success');
            saveGameState();
            updateUI();
            closeVideoModal();
        }

        // MEDIA GALLERY FUNCTION
        function renderMediaSection() {
            const mediaContainer = document.getElementById('mediaContainer');
            if (!mediaContainer) return;
            
            let html = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400 mb-2">📷 Campaign Media Gallery</h2>
                    <p class="text-gray-400">Explore party logos, candidate photos, and campaign materials</p>
                </div>
                
                <!-- Party Logos Section -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-blue-400 mb-4">🏛️ Political Party Logos</h3>
                    <div class="grid grid-cols-2 gap-4">
            `;
            
            // Party Logos
            Object.entries(INITIAL_PARTY_DATA).forEach(([partyId, party]) => {
                html += `
                    <div class="media-card bg-slate-800 p-4 rounded-lg text-center">
                        <img src="${party.logoImage}" 
                             alt="${party.name}" 
                             class="party-logo mx-auto mb-2"
                             onerror="this.src='/assets/parties/logos/placeholder-logo.png'">
                        <h4 class="font-bold text-sm mb-1">${party.name.split('(')[0].trim()}</h4>
                        <p class="text-xs text-gray-400 mb-3">${party.description}</p>
                        <div class="flex justify-center space-x-2">
                            <a href="${party.socialLinks.website}" target="_blank" 
                               class="text-blue-400 hover:text-blue-300 text-xs">
                                <i class="fas fa-globe"></i>
                            </a>
                            <a href="${party.socialLinks.twitter}" target="_blank" 
                               class="text-blue-400 hover:text-blue-300 text-xs">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="${party.socialLinks.youtube}" target="_blank" 
                               class="text-red-400 hover:text-red-300 text-xs">
                                <i class="fab fa-youtube"></i>
                            </a>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <!-- Candidate Photos Section -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-green-400 mb-4">👥 Candidate Photos</h3>
                    <div class="grid grid-cols-2 gap-4">
            `;
            
            // Candidate Photos
            CANDIDATE_POOL.forEach(candidate => {
                const party = INITIAL_PARTY_DATA[candidate.partyId];
                html += `
                    <div class="media-card bg-slate-800 p-4 rounded-lg text-center">
                        <img src="${candidate.photo}" 
                             alt="${candidate.name}" 
                             class="candidate-photo mx-auto mb-2 border-2 ${candidate.logoColor.replace('text', 'border')}"
                             onerror="this.src='/assets/candidates/photos/placeholder-photo.jpg'">
                        <h4 class="font-bold text-sm mb-1">${candidate.name.split('(')[0].trim()}</h4>
                        <p class="text-xs text-gray-400 mb-2">${candidate.party.split('(')[0].trim()}</p>
                        <p class="text-xs text-gray-300 mb-3">${candidate.campaign}</p>
                        <button onclick="watchPromoVideo(${candidate.id})" 
                                class="w-full bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded text-xs">
                            📺 Watch Video (+${candidate.videoReward.toLocaleString()})
                        </button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <!-- Campaign Videos Section -->
                <div>
                    <h3 class="text-xl font-bold text-purple-400 mb-4">🎬 Campaign Videos</h3>
                    <p class="text-gray-400 text-sm mb-4">Watch campaign videos to earn bonus coins!</p>
                    <div class="space-y-4">
            `;
            
            // Campaign Videos
            CANDIDATE_POOL.forEach(candidate => {
                const hasWatched = gameState.watchedVideos[candidate.id];
                html += `
                    <div class="media-card bg-slate-800 p-4 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <img src="${candidate.photo}" 
                                 alt="${candidate.name}" 
                                 class="w-16 h-16 rounded-full object-cover"
                                 onerror="this.src='/assets/candidates/photos/placeholder-photo.jpg'">
                            <div class="flex-1">
                                <h4 class="font-bold">${candidate.name}</h4>
                                <p class="text-sm text-gray-400">${candidate.party}</p>
                                <p class="text-xs text-gray-300">${candidate.campaign}</p>
                            </div>
                            <div class="text-right">
                                <button onclick="watchPromoVideo(${candidate.id})" 
                                        class="${hasWatched ? 'bg-gray-500' : 'bg-red-500 hover:bg-red-600'} text-white py-2 px-4 rounded-lg text-sm">
                                    ${hasWatched ? '✅ Watched' : '📺 Watch'}
                                </button>
                                <p class="text-green-400 text-xs mt-1">+${candidate.videoReward.toLocaleString()} coins</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            mediaContainer.innerHTML = html;
        }

        // The rest of your existing functions (handleTap, activateCard, upgradeCard, etc.)
        // ... [Keep all your existing game functions from the previous version]
        
        // Make sure to add the media section to your navigation
        function navigate(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Trigger render functions for non-main tabs
            if (tabId === 'cards') renderCardsSection();
            if (tabId === 'party') renderPartySection();
            if (tabId === 'media') renderMediaSection();
            if (tabId === 'store') renderStoreSection();
            if (tabId === 'leaderboard') renderLeaderboardSection();
        }

        // Add these to your existing initialization
        document.addEventListener('DOMContentLoaded', () => {
            // ... your existing initialization code
            
            // Add media section to navigation
            // This is already included in the updated nav bar above
        });

        // Make functions available globally
        window.watchPromoVideo = watchPromoVideo;
        window.closeVideoModal = closeVideoModal;
        window.claimVideoReward = claimVideoReward;

        // Note: Due to character limits, I've kept the core game functions brief.
        // You'll need to integrate these media features with your existing game logic.
    </script>
</body>
</html>
