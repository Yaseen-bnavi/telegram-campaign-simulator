<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Campaign Simulator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background for a serious theme */
        }
        .app-container {
            max-width: 420px;
            min-height: 100vh;
            background-color: #161b22; /* Slightly lighter inner container */
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        .tab-button.active {
            border-bottom: 3px solid #00f0ff;
            color: #00f0ff;
            font-weight: 700;
        }
        .tap-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px #00a8ff;
            animation: pulse-shadow 2s infinite;
        }
        .tap-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #0088cc;
        }
        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), 0 4px #00a8ff; }
            50% { box-shadow: 0 0 15px rgba(0, 255, 255, 1), 0 6px #00a8ff; }
            100% { box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), 0 4px #00a8ff; }
        }
        .upgrade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
        }
        .leader-item:nth-child(1) { background-color: #ffd70030; } /* Gold */
        .leader-item:nth-child(2) { background-color: #c0c0c030; } /* Silver */
        .leader-item:nth-child(3) { background-color: #cd7f3230; } /* Bronze */
    </style>
</head>
<body class="flex justify-center text-white p-4">

    <div id="app" class="app-container w-full p-4 rounded-xl">
        
        <!-- Header & Top Bar -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black text-cyan-400">Campaign Simulator</h1>
            <p class="text-xs text-gray-400">User ID: <span id="user-id">Loading...</span></p>
        </header>

        <!-- Stats Bar -->
        <div class="flex justify-around items-center bg-gray-800/50 p-3 rounded-lg mb-6 shadow-lg">
            <div class="text-center">
                <p class="text-xl font-bold text-yellow-400" id="coin-display">0 ðŸª™</p>
                <p class="text-xs text-gray-400">Funds</p>
            </div>
            <div class="text-center">
                <p class="text-xl font-bold text-blue-400" id="tci-display">0 TCI</p>
                <p class="text-xs text-gray-400">Influence (Total)</p>
            </div>
            <div class="text-center">
                <p class="text-xl font-bold text-red-400" id="base-tap-display">+1/tap</p>
                <p class="text-xs text-gray-400">Power</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="flex justify-around border-b border-gray-700 mb-6">
            <button class="tab-button p-3 flex-1 text-sm active" data-tab="tap-view">Tap</button>
            <button class="tab-button p-3 flex-1 text-sm" data-tab="upgrade-view">Upgrades</button>
            <button class="tab-button p-3 flex-1 text-sm" data-tab="leaderboard-view">Leaderboard</button>
            <button class="tab-button p-3 flex-1 text-sm" data-tab="tokens-view">Tokens</button>
        </nav>

        <!-- View Containers -->

        <!-- 1. TAP View -->
        <section id="tap-view" class="view-content">
            <div class="text-center p-6">
                <button id="tap-button" class="tap-button bg-cyan-600 hover:bg-cyan-500 text-white font-extrabold py-6 px-12 rounded-full text-2xl transition duration-150">
                    Propaganda Push!
                </button>
                <p id="tap-reward-info" class="text-sm mt-4 text-gray-300">Gains: +<span id="tap-gain">1</span> Funds</p>
                <div id="floating-rewards" class="relative mt-2"></div>
            </div>

            <div class="mt-8 bg-gray-800/50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-cyan-400 mb-3">Party Status</h3>
                <p class="text-sm text-gray-300">Next Party Level at: <span id="next-level-tci">1,000</span> TCI</p>
                <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                    <div id="tci-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs text-right mt-1 text-gray-400"><span id="current-tci-progress">0</span> TCI</p>
            </div>
        </section>

        <!-- 2. UPGRADES View -->
        <section id="upgrade-view" class="view-content hidden">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Campaign Headquarters</h2>
            <div id="upgrade-list" class="space-y-4">
                <!-- Upgrades will be dynamically inserted here -->
            </div>
        </section>

        <!-- 3. LEADERBOARD View -->
        <section id="leaderboard-view" class="view-content hidden">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Global Influence Ranking</h2>
            <div class="flex justify-between text-xs font-semibold text-gray-400 border-b border-gray-700 pb-2 mb-2">
                <span class="w-1/6">Rank</span>
                <span class="w-3/6">User ID</span>
                <span class="w-2/6 text-right">TCI</span>
            </div>
            <div id="leaderboard-list" class="space-y-2">
                <p class="text-center text-gray-500">Loading Leaderboard...</p>
                <!-- Leaders dynamically inserted here -->
            </div>
        </section>

        <!-- 4. TOKENS View -->
        <section id="tokens-view" class="view-content hidden">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Influence Tokens (ðŸ’Ž)</h2>
            <div class="bg-gray-800/50 p-4 rounded-lg mb-6">
                <p class="text-lg font-bold text-purple-400">You have: <span id="token-count">0</span> ðŸ’Ž</p>
                <p class="text-sm mt-2 text-gray-300">Influence Tokens are permanent, rare resources earned by reaching Party Milestones or winning Weekly Rallies. Use them for powerful, non-coin based upgrades.</p>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-purple-400">Token Market</h3>
            <div id="token-upgrade-list" class="space-y-4">
                <!-- Token Upgrades will be dynamically inserted here -->
            </div>
        </section>

        <!-- Modal Placeholder (for confirmation/messages) -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
            <div class="bg-gray-800 p-6 rounded-lg w-11/12 max-w-sm text-center shadow-2xl border border-cyan-600">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-cyan-400"></h3>
                <p id="modal-message" class="text-gray-300 mb-4"></p>
                <button id="modal-close-button" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded transition duration-150">
                    Got it
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase and Application Script -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

        // Global Firebase and Game State Variables
        setLogLevel('Debug'); // Enable debug logging for Firebase
        let app;
        let db;
        let auth;
        let appId = 'default-app-id'; // Global declaration for appId
        let userId = 'loading'; // Will be updated on successful auth
        let userDocRef; // Firestore reference to the user's data

        // Game State
        const gameState = {
            coins: 0,
            baseTapPower: 1,
            totalCampaignInfluence: 0, // TCI is the high score
            influenceTokens: 0, // Rare currency
            upgrades: {}, // Stores current level for each upgrade
            tokenUpgrades: {}, // Stores current level for each token upgrade
        };

        // --- GAME CONFIGURATION ---
        const TAP_MULTIPLIER_BASE = 1;
        const TCI_PER_LEVEL = 1000;
        const TCI_GOAL_MULTIPLIER = 1.5;

        // Upgrades Config
        const upgradesConfig = [
            { id: 'tapEfficiency', name: 'Tap Efficiency', baseCost: 50, costMultiplier: 1.5, effect: 'baseTapPower', effectValue: 1, maxLevel: 50 },
            { id: 'recruitmentDrive', name: 'Recruitment Drive', baseCost: 500, costMultiplier: 1.8, effect: 'passiveIncome', effectValue: 5, maxLevel: 25 }, // Passive income is TCI/second
            { id: 'mediaOutreach', name: 'Media Outreach', baseCost: 2000, costMultiplier: 2.0, effect: 'tapMultiplier', effectValue: 0.1, maxLevel: 10 },
        ];

        // Token Upgrades Config (Permanent, TCI-boosting)
        const tokenUpgradesConfig = [
            { id: 'influenceFocus', name: 'Influence Focus', cost: 1, maxLevel: 3, effect: 'tciBonus', effectValue: 0.10, description: 'Increases TCI gain by 10% per level.' },
            { id: 'rareCardDrop', name: 'Rare Asset Drop', cost: 5, maxLevel: 1, effect: 'rareDropRate', effectValue: 1, description: 'Permanent 2x chance for rare rewards from taps.' },
        ];

        // --- UTILITY FUNCTIONS ---
        const showMessage = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
        };

        const hideMessage = () => {
            document.getElementById('modal-close-button').removeEventListener('click', hideMessage); // Clean up old listener
            document.getElementById('message-modal').classList.add('hidden');
        };
        // Re-attach listener outside the definition scope
        document.getElementById('modal-close-button').addEventListener('click', hideMessage);

        const formatNumber = (num) => {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toLocaleString();
        };

        const calculateCost = (upgrade, currentLevel) => {
            return Math.floor(upgrade.baseCost * (upgrade.costMultiplier ** currentLevel));
        };

        const updateUI = () => {
            document.getElementById('coin-display').textContent = `${formatNumber(gameState.coins)} ðŸª™`;
            document.getElementById('tci-display').textContent = `${formatNumber(gameState.totalCampaignInfluence)} TCI`;
            document.getElementById('base-tap-display').textContent = `+${formatNumber(gameState.baseTapPower)}/tap`;
            document.getElementById('token-count').textContent = gameState.influenceTokens;
            document.getElementById('tap-gain').textContent = formatNumber(gameState.baseTapPower * TAP_MULTIPLIER_BASE);

            // TCI Progress Bar
            let nextLevelTCI = TCI_PER_LEVEL;
            while (gameState.totalCampaignInfluence >= nextLevelTCI) {
                nextLevelTCI = Math.floor(nextLevelTCI * TCI_GOAL_MULTIPLIER);
            }
            const prevLevelTCI = Math.floor(nextLevelTCI / TCI_GOAL_MULTIPLIER);
            const progressRange = nextLevelTCI - prevLevelTCI;
            const currentProgress = gameState.totalCampaignInfluence - prevLevelTCI;
            const progressPercent = (currentProgress / progressRange) * 100;

            document.getElementById('next-level-tci').textContent = formatNumber(nextLevelTCI);
            document.getElementById('current-tci-progress').textContent = formatNumber(gameState.totalCampaignInfluence);
            document.getElementById('tci-progress').style.width = `${Math.min(100, progressPercent)}%`;

            renderUpgrades();
            renderTokenUpgrades();
        };
        
        // --- GAME LOGIC ---
        const tap = async () => {
            if (userId === 'loading') return showMessage("Authentication Pending", "Please wait for the user ID to load before tapping.");

            const tapGain = gameState.baseTapPower * TAP_MULTIPLIER_BASE;

            // Use transaction for safe, concurrent updates
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(userDocRef);
                    if (!docSnapshot.exists()) {
                        throw "Document does not exist!";
                    }
                    const data = docSnapshot.data();
                    
                    // New values
                    const newCoins = data.coins + tapGain;
                    const newTCI = data.totalCampaignInfluence + 1; // TCI increases slightly with every tap

                    transaction.update(userDocRef, {
                        coins: newCoins,
                        totalCampaignInfluence: newTCI,
                    });

                    // Add floating reward effect
                    createFloatingReward(`+${formatNumber(tapGain)} ðŸª™`);
                });
            } catch (error) {
                console.error("Tap Transaction failed: ", error);
            }
        };

        // UI function for floating reward effect
        const createFloatingReward = (text) => {
            const container = document.getElementById('floating-rewards');
            const reward = document.createElement('div');
            reward.textContent = text;
            reward.className = 'absolute font-bold text-lg text-yellow-300 opacity-0 transition-all duration-1000 ease-out';
            reward.style.top = `${Math.random() * 20 - 10}px`;
            reward.style.left = '50%';
            reward.style.transform = `translateX(-50%)`;
            
            container.appendChild(reward);
            
            // Trigger animation
            setTimeout(() => {
                reward.style.opacity = '1';
                reward.style.transform = `translate(-50%, -50px)`;
            }, 10);
            
            // Remove after animation
            setTimeout(() => {
                reward.remove();
            }, 1000);
        };

        const buyUpgrade = async (upgradeId) => {
            if (userId === 'loading') return showMessage("Authentication Pending", "Please wait for the user ID to load.");

            const upgrade = upgradesConfig.find(u => u.id === upgradeId);
            if (!upgrade) return;

            const currentLevel = gameState.upgrades[upgradeId] || 0;
            if (currentLevel >= upgrade.maxLevel) return showMessage("Max Level Reached", `${upgrade.name} is already at max level (${upgrade.maxLevel}).`);

            const cost = calculateCost(upgrade, currentLevel);
            if (gameState.coins < cost) return showMessage("Insufficient Funds", `Need ${formatNumber(cost)} ðŸª™ for the next level of ${upgrade.name}.`);

            // Use transaction for buy logic
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(userDocRef);
                    if (!docSnapshot.exists()) throw "Document does not exist!";
                    const data = docSnapshot.data();

                    const currentCoins = data.coins;
                    const nextLevel = (data.upgrades[upgradeId] || 0) + 1;
                    const nextBaseTapPower = data.baseTapPower + upgrade.effectValue; // Simplistic effect

                    // Check again inside transaction
                    if (currentCoins < cost) throw new Error("Funds check failed in transaction.");

                    // Update data
                    transaction.update(userDocRef, {
                        coins: currentCoins - cost,
                        baseTapPower: nextBaseTapPower,
                        [`upgrades.${upgradeId}`]: nextLevel,
                    });
                });
                showMessage("Upgrade Successful!", `${upgrade.name} upgraded to Level ${currentLevel + 1}!`);
            } catch (error) {
                console.error("Upgrade Transaction failed: ", error);
                if (error.message === "Funds check failed in transaction.") {
                     showMessage("Transaction Failed", "Your funds changed during purchase. Please try again.");
                }
            }
        };

        const renderUpgrades = () => {
            const list = document.getElementById('upgrade-list');
            list.innerHTML = '';
            
            upgradesConfig.forEach(upgrade => {
                const currentLevel = gameState.upgrades[upgrade.id] || 0;
                const cost = calculateCost(upgrade, currentLevel);
                const maxLevel = currentLevel >= upgrade.maxLevel;
                
                const card = document.createElement('div');
                card.className = `upgrade-card bg-gray-800 p-4 rounded-lg flex justify-between items-center transition duration-200 cursor-pointer ${maxLevel ? 'opacity-50' : ''}`;
                card.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-lg text-white">${upgrade.name} (Lvl ${currentLevel})</h4>
                        <p class="text-sm text-gray-400">Effect: +${upgrade.effectValue} ${upgrade.effect}</p>
                    </div>
                    <button id="buy-${upgrade.id}" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-150"
                        ${maxLevel ? 'disabled' : ''}>
                        ${maxLevel ? 'MAX' : `${formatNumber(cost)} ðŸª™`}
                    </button>
                `;
                list.appendChild(card);
                
                if (!maxLevel) {
                    document.getElementById(`buy-${upgrade.id}`).addEventListener('click', () => buyUpgrade(upgrade.id));
                }
            });
        };

        const renderTokenUpgrades = () => {
            const list = document.getElementById('token-upgrade-list');
            list.innerHTML = '';

            tokenUpgradesConfig.forEach(upgrade => {
                const currentLevel = gameState.tokenUpgrades[upgrade.id] || 0;
                const maxLevel = currentLevel >= upgrade.maxLevel;

                const card = document.createElement('div');
                card.className = `upgrade-card bg-gray-800 p-4 rounded-lg flex justify-between items-center transition duration-200 cursor-pointer ${maxLevel ? 'opacity-50' : ''}`;
                card.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-lg text-purple-400">${upgrade.name} (Lvl ${currentLevel})</h4>
                        <p class="text-sm text-gray-400">${upgrade.description}</p>
                    </div>
                    <button id="buy-token-${upgrade.id}" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded transition duration-150"
                        ${maxLevel || gameState.influenceTokens < upgrade.cost ? 'disabled' : ''}>
                        ${maxLevel ? 'MAX' : `${upgrade.cost} ðŸ’Ž`}
                    </button>
                `;
                list.appendChild(card);
                
                if (!maxLevel && gameState.influenceTokens >= upgrade.cost) {
                    document.getElementById(`buy-token-${upgrade.id}`).addEventListener('click', () => showMessage("Token Upgrade", "Token Upgrades are currently only visual.")); // Placeholder logic
                }
            });
        }


        // --- LEADERBOARD LOGIC ---
        const setupLeaderboardListener = () => {
            const leaderboardList = document.getElementById('leaderboard-list');
            // Uses global appId
            const leaderboardQuery = query(collection(db, `artifacts/${appId}/public/data/leaderboard`));
            
            // Listen for real-time updates
            onSnapshot(leaderboardQuery, (snapshot) => {
                let leaders = [];
                snapshot.forEach(docEntry => { // Fixed: Renamed parameter from 'doc' to 'docEntry'
                    const data = docEntry.data();
                    // Ensure the document ID is not the user's ID for simplicity,
                    // but we generally fetch all and sort.
                    leaders.push({
                        id: docEntry.id,
                        tci: data.totalCampaignInfluence || 0
                    });
                });

                // Sort by TCI descending and take the top 10
                leaders.sort((a, b) => b.tci - a.tci);
                leaders = leaders.slice(0, 10);
                
                leaderboardList.innerHTML = ''; // Clear existing list

                if (leaders.length === 0) {
                    leaderboardList.innerHTML = '<p class="text-center text-gray-500 mt-4">Be the first to join the campaign!</p>';
                    return;
                }

                leaders.forEach((leader, index) => {
                    const item = document.createElement('div');
                    item.className = `leader-item flex justify-between items-center p-3 rounded-lg ${leader.id === userId ? 'border-2 border-cyan-400' : 'bg-gray-700/50'}`;
                    item.innerHTML = `
                        <span class="w-1/6 font-bold text-lg text-cyan-400">${index + 1}</span>
                        <span class="w-3/6 text-sm truncate">${leader.id}</span>
                        <span class="w-2/6 text-right font-semibold">${formatNumber(leader.tci)}</span>
                    `;
                    leaderboardList.appendChild(item);
                });
            }, (error) => {
                console.error("Leaderboard Snapshot error:", error);
                leaderboardList.innerHTML = '<p class="text-center text-red-400 mt-4">Failed to load leaderboard.</p>';
            });
        };
        
        // --- FIREBASE INITIALIZATION AND AUTHENTICATION (The Fix) ---
        const initializeFirebase = async () => {
            try {
                // Get global variables (MANDATORY for Canvas environment)
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fetched here

                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    showMessage("Setup Error", "Firebase configuration is not available.");
                    return;
                }

                // Initialize services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                appId = canvasAppId; // Set the global appId here

                // 1. Set up the state change listener *before* signing in
                // This correctly uses the imported onAuthStateChanged function and the defined auth object.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;

                        // Set up Firestore references (uses global appId)
                        userDocRef = doc(db, `artifacts/${appId}/users/${userId}/game_data`, 'user_state');
                        
                        // Try to get existing data or initialize new data
                        await initializeUserData();
                        
                        // Set up real-time listeners
                        setupUserSnapshotListener();
                        setupLeaderboardListener();
                    } else {
                        // This should ideally not happen in the Canvas environment
                        console.log("User signed out or failed to authenticate.");
                        // Attempt to sign in if no user is present
                        if (!initialAuthToken) {
                            await signInAnonymously(auth);
                        }
                    }
                });

                // 2. Authenticate using the custom token provided by the environment
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    // Fallback to anonymous sign-in if token is missing
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                showMessage("Authentication Failed", "Could not connect to Firebase services. Check console for details.");
            }
        };

        const initializeUserData = async () => {
            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                const initialData = {
                    coins: 0,
                    baseTapPower: 1,
                    totalCampaignInfluence: 0,
                    influenceTokens: 0,
                    upgrades: {},
                    tokenUpgrades: {},
                    lastActive: Date.now(),
                };
                await setDoc(userDocRef, initialData);

                // Also initialize a public leaderboard entry (uses global appId)
                const publicDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, userId);
                await setDoc(publicDocRef, { totalCampaignInfluence: 0, lastUpdated: Date.now() });

                console.log("User data initialized.");
            }
        };

        // Real-time listener for the user's data
        const setupUserSnapshotListener = () => {
            onSnapshot(userDocRef, (docSnap) => { // Fixed: Renamed parameter from 'doc' to 'docSnap'
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.coins = data.coins || 0;
                    gameState.baseTapPower = data.baseTapPower || 1;
                    gameState.totalCampaignInfluence = data.totalCampaignInfluence || 0;
                    gameState.influenceTokens = data.influenceTokens || 0;
                    gameState.upgrades = data.upgrades || {};
                    gameState.tokenUpgrades = data.tokenUpgrades || {};
                    updateUI();

                    // Update public leaderboard data on change (simple, non-transactional update) (uses global appId)
                    const publicDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, userId);
                    updateDoc(publicDocRef, { totalCampaignInfluence: gameState.totalCampaignInfluence, lastUpdated: Date.now() })
                        .catch(err => console.error("Failed to update public TCI:", err));
                        
                } else {
                    console.warn("User document is missing after initialization.");
                    // Re-initialize if missing, though it shouldn't happen here
                }
            }, (error) => {
                console.error("User Snapshot error:", error);
                showMessage("Data Error", "Failed to connect to real-time data. Check console.");
            });
        };
        
        // --- EVENT LISTENERS ---
        const setupEventListeners = () => {
            // Tab Navigation
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));

                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.tab).classList.remove('hidden');
                });
            });

            // Tap Button
            document.getElementById('tap-button').addEventListener('click', tap);
        };
        
        // --- INITIALIZATION ---
        window.onload = () => {
            setupEventListeners();
            initializeFirebase();
        };

    </script>
</body>
</html>
